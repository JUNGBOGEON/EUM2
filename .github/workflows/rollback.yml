name: 배포 롤백

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: '롤백할 Docker 이미지 태그 (예: abc1234 또는 실행 번호)'
        required: true
        type: string
      reason:
        description: '롤백 사유'
        required: true
        type: string

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: eum-backend
  ECS_SERVICE: eum-backend-service
  ECS_CLUSTER: eum-cluster-prod
  ECS_TASK_DEFINITION: backend/ecs/task-definition.json
  CONTAINER_NAME: eum-backend

jobs:
  rollback:
    name: 이전 버전으로 롤백
    runs-on: ubuntu-latest
    environment:
      name: production
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: 저장소 체크아웃
        uses: actions/checkout@v4

      - name: AWS 자격 증명 구성
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECR 로그인
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: 이미지 존재 여부 확인
        run: |
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ github.event.inputs.image_tag }} \
            || (echo "이미지 태그를 찾을 수 없습니다!" && exit 1)

      - name: 태스크 정의 준비
        run: |
          sed -i "s/YOUR_ACCOUNT_ID/${{ secrets.AWS_ACCOUNT_ID }}/g" ${{ env.ECS_TASK_DEFINITION }}

      - name: 롤백 이미지로 태스크 정의 업데이트
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEFINITION }}
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.event.inputs.image_tag }}

      - name: 롤백 태스크 정의 배포
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 10

      - name: 롤백 요약
        run: |
          echo "## 롤백 요약" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 항목 | 값 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| 이미지 태그 | ${{ github.event.inputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 사유 | ${{ github.event.inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 실행자 | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 시간 | $(date -u +"%Y-%m-%dT%H:%M:%SZ") |" >> $GITHUB_STEP_SUMMARY

      - name: Slack 알림
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "EUM 백엔드 롤백 실행됨",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "롤백 실행됨 :warning:",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*롤백 버전:*\n${{ github.event.inputs.image_tag }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*사유:*\n${{ github.event.inputs.reason }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*실행자:*\n${{ github.actor }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
